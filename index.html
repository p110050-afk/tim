<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <link id="favicon" rel="icon" href="" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¨‹å¼ç·¨è¼¯å™¨</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .toolbar {
            background: #2d2d30;
            padding: 8px 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            border-bottom: 1px solid #3e3e42;
            position: relative;
        }
        
        .toolbar h1 {
            font-size: 14px;
            margin-right: 15px;
            color: #cccccc;
        }
        
        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            font-family: inherit;
            transition: background 0.2s;
            color: white;
        }
        
        .btn-primary { background: #0e639c; }
        .btn-primary:hover { background: #1177bb; }
        .btn-success { background: #107c10; }
        .btn-success:hover { background: #14a414; }
        .btn-warning { background: #ca5010; }
        .btn-warning:hover { background: #e85d1a; }
        .btn-danger { background: #c50e2f; }
        .btn-danger:hover { background: #e81041; }
        .btn-secondary { background: #5a5a5a; }
        .btn-secondary:hover { background: #6e6e6e; }
        
        .file-select {
            background: #3c3c3c;
            border: 1px solid #5a5a5a;
            color: #cccccc;
            padding: 5px 8px;
            border-radius: 3px;
            font-size: 11px;
            min-width: 150px;
        }
        
        .file-input {
            display: none;
        }
        
        /* æœå°‹å·¥å…·åˆ— */
        .search-toolbar {
            background: #252526;
            border-bottom: 1px solid #3e3e42;
            padding: 8px 10px;
            display: none;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .search-input {
            background: #3c3c3c;
            border: 1px solid #5a5a5a;
            color: #cccccc;
            padding: 6px 10px;
            border-radius: 3px;
            font-size: 12px;
            min-width: 200px;
            font-family: inherit;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #007acc;
        }
        
        .search-results {
            color: #cccccc;
            font-size: 11px;
            white-space: nowrap;
        }
        
        .search-nav-btn {
            padding: 4px 8px;
            background: #5a5a5a;
            border: none;
            border-radius: 3px;
            color: white;
            cursor: pointer;
            font-size: 11px;
            min-width: 24px;
        }
        
        .search-nav-btn:hover {
            background: #6e6e6e;
        }
        
        .search-nav-btn:disabled {
            background: #404040;
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        .main-container {
            display: flex;
            flex: 1;
            min-height: 0;
        }
        
        .editor-container {
            flex: 1;
            position: relative;
            background: #1e1e1e;
            display: flex;
        }
        
        .line-numbers {
            background: #252526;
            color: #858585;
            padding: 15px 8px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            text-align: right;
            min-width: 50px;
            border-right: 1px solid #3e3e42;
            user-select: none;
            overflow: hidden;
            white-space: pre;
        }
        
        .editor-wrapper {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        
        .code-editor {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            resize: none;
            outline: none;
            background: transparent;
            color: transparent;
            caret-color: #d4d4d4;
            tab-size: 4;
            z-index: 2;
        }
        
        .syntax-highlight {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            background: #1e1e1e;
            overflow: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            pointer-events: none;
            z-index: 1;
        }
        
        /* èªæ³•é«˜äº®é¡è‰² (VS Code Dark é¢¨æ ¼) */
        .html-tag { color: #569cd6; font-weight: normal; }
        .html-attribute { color: #92c5f8; }
        .html-string { color: #ce9178; }
        .html-comment { color: #6a9955; font-style: italic; }
        .html-doctype { color: #569cd6; font-weight: bold; }
        .css-selector { color: #d7ba7d; }
        .css-property { color: #9cdcfe; }
        .css-value { color: #ce9178; }
        .js-keyword { color: #569cd6; font-weight: bold; }
        .js-string { color: #ce9178; }
        .js-comment { color: #6a9955; font-style: italic; }
        .js-number { color: #b5cea8; }
        
        /* æœå°‹é«˜äº® */
        .search-highlight {
            background: #613214;
            border-radius: 2px;
            padding: 0 1px;
        }
        
        .search-highlight.current {
            background: #f99b11;
            color: #000;
        }
        
        .status-bar {
            background: #007acc;
            color: white;
            padding: 4px 10px;
            font-size: 11px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .status-left, .status-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        .autosave-indicator {
            position: fixed;
            top: 50px;
            right: 20px;
            background: #107c10;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        
        .autosave-indicator.show {
            opacity: 1;
        }
        
        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 11px;
        }
        
        .checkbox-container input[type="checkbox"] {
            margin: 0;
        }
        
        @media (max-width: 768px) {
            .toolbar {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .toolbar h1 {
                width: 100%;
                margin-bottom: 5px;
                margin-right: 0;
            }
            
            .btn {
                padding: 4px 8px;
                font-size: 10px;
            }
            
            .search-toolbar {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .search-input {
                min-width: 150px;
            }
            
            .status-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <h1>ğŸ“ ç¨‹å¼ç·¨è¼¯å™¨</h1>
        
        <select id="fileSelect" class="file-select">
            <option value="">é¸æ“‡æª”æ¡ˆ...</option>
        </select>
        
        <button class="btn btn-primary" onclick="openFiles()">é–‹å•Ÿæª”æ¡ˆ</button>
        <button class="btn btn-success" onclick="newFile()">æ–°æª”æ¡ˆ</button>
        <button class="btn btn-primary" onclick="saveFile()">å„²å­˜</button>
        <button class="btn btn-secondary" onclick="renameFile()">é‡æ–°å‘½å</button>
        <button class="btn btn-danger" onclick="closeFile()">é—œé–‰æª”æ¡ˆ</button>
        
        <button class="btn btn-secondary" onclick="copyAll()">è¤‡è£½å…¨æ–‡</button>
        <button class="btn btn-secondary" onclick="pasteContent()">è²¼ä¸Š</button>
        <button class="btn btn-warning" onclick="clearContent()">æ¸…é™¤å…§å®¹</button>
        
        <button class="btn btn-success" onclick="runHTML()" id="runBtn" style="display: none;">åŸ·è¡ŒHTML</button>
        <button class="btn btn-secondary" onclick="toggleSearch()">ğŸ” æœå°‹</button>
        
        <button class="btn btn-primary" onclick="saveToIndexedDB()">ğŸ’¾ å„²å­˜åˆ°è³‡æ–™åº«</button>
        <button class="btn btn-success" onclick="loadFromIndexedDB()">ğŸ“‚ å¾è³‡æ–™åº«è¼‰å…¥</button>
        <button class="btn btn-warning" onclick="exportAllFiles()">ğŸ“¤ åŒ¯å‡ºæ‰€æœ‰æª”æ¡ˆ</button>
        <button class="btn btn-danger" onclick="clearDatabase()">ğŸ—‘ï¸ æ¸…é™¤è³‡æ–™åº«</button>
        
        <div class="checkbox-container">
            <input type="checkbox" id="wordWrapToggle" onchange="toggleWordWrap()">
            <label for="wordWrapToggle">è‡ªå‹•æ›è¡Œ</label>
        </div>
        
        <input type="file" id="fileInput" class="file-input" multiple 
               accept=".html,.htm,.css,.js,.txt,.json,.xml,.md,.py,.java,.cpp,.c,.php,.rb,.go,.rs,.ts,.jsx,.tsx,.vue,.scss,.sass,.less,.sql,.sh,.bat,.yaml,.yml,.ini,.cfg,.conf">
    </div>
    
    <!-- æœå°‹å·¥å…·åˆ— -->
    <div id="searchToolbar" class="search-toolbar">
        <input type="text" id="searchInput" class="search-input" placeholder="è¼¸å…¥æœå°‹å…§å®¹...">
        <div class="checkbox-container">
            <input type="checkbox" id="caseSensitiveToggle">
            <label for="caseSensitiveToggle">å€åˆ†å¤§å°å¯«</label>
        </div>
        <div class="checkbox-container">
            <input type="checkbox" id="wholeWordToggle">
            <label for="wholeWordToggle">æ•´å­—åŒ¹é…</label>
        </div>
        <button class="search-nav-btn" id="prevBtn" onclick="navigateSearch(-1)" title="ä¸Šä¸€å€‹">â†‘</button>
        <button class="search-nav-btn" id="nextBtn" onclick="navigateSearch(1)" title="ä¸‹ä¸€å€‹">â†“</button>
        <div class="search-results" id="searchResults"></div>
        <button class="btn btn-secondary" onclick="toggleSearch()">âœ•</button>
    </div>
    
    <div class="main-container">
        <div class="editor-container">
            <div id="lineNumbers" class="line-numbers">1</div>
            <div class="editor-wrapper">
                <div id="syntaxHighlight" class="syntax-highlight"></div>
                <textarea id="codeEditor" class="code-editor" placeholder="é¸æ“‡æˆ–å‰µå»ºä¸€å€‹æª”æ¡ˆé–‹å§‹ç·¨è¼¯..."></textarea>
            </div>
        </div>
    </div>
    
    <div class="status-bar">
        <div class="status-left">
            <span id="fileStatus">æœªé¸æ“‡æª”æ¡ˆ</span>
            <span id="saveStatus"></span>
            <span id="dbStatus">è³‡æ–™åº«: æœªåˆå§‹åŒ–</span>
        </div>
        <div class="status-right">
            <span id="fileCount">æª”æ¡ˆ: 0</span>
            <span id="lineCount">è¡Œ: 0</span>
            <span id="charCount">å­—å…ƒ: 0</span>
        </div>
    </div>
    
    <div id="autosaveIndicator" class="autosave-indicator">
        è‡ªå‹•å„²å­˜å®Œæˆ
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let files = {};
        let currentFile = null;
        let fileCounter = 1;
        let autosaveTimeout = null;
        let isModified = false;
        let searchResults = [];
        let currentSearchIndex = -1;
        let isSearchVisible = false;
        let db = null;
        
        // DOM å…ƒç´ 
        const codeEditor = document.getElementById('codeEditor');
        const syntaxHighlight = document.getElementById('syntaxHighlight');
        const lineNumbers = document.getElementById('lineNumbers');
        const fileSelect = document.getElementById('fileSelect');
        const fileStatus = document.getElementById('fileStatus');
        const saveStatus = document.getElementById('saveStatus');
        const dbStatus = document.getElementById('dbStatus');
        const fileCount = document.getElementById('fileCount');
        const lineCount = document.getElementById('lineCount');
        const charCount = document.getElementById('charCount');
        const autosaveIndicator = document.getElementById('autosaveIndicator');
        const runBtn = document.getElementById('runBtn');
        const searchToolbar = document.getElementById('searchToolbar');
        const searchInput = document.getElementById('searchInput');
        const searchResultsDiv = document.getElementById('searchResults');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const caseSensitiveToggle = document.getElementById('caseSensitiveToggle');
        const wholeWordToggle = document.getElementById('wholeWordToggle');
        
        // åˆå§‹åŒ–
        initIndexedDB();
        loadFromLocalStorage();
        updateUI();        
        function initIndexedDB() {
            const request = indexedDB.open('CodeEditorDB', 1);
            
            request.onerror = function(event) {
                console.error('IndexedDB åˆå§‹åŒ–å¤±æ•—:', event.target.error);
                dbStatus.textContent = 'è³‡æ–™åº«: éŒ¯èª¤';
                dbStatus.style.color = '#f14c4c';
            };
            
            request.onsuccess = function(event) {
                db = event.target.result;
                console.log('IndexedDB åˆå§‹åŒ–æˆåŠŸ');
                dbStatus.textContent = 'è³‡æ–™åº«: å·²é€£ç·š';
                dbStatus.style.color = '#6a9955';
                
                // è‡ªå‹•å¾ IndexedDB è¼‰å…¥æª”æ¡ˆ
                loadFromIndexedDB();
            };
            
            request.onupgradeneeded = function(event) {
                db = event.target.result;
                
                // å‰µå»ºç‰©ä»¶å­˜å„²
                if (!db.objectStoreNames.contains('files')) {
                    const fileStore = db.createObjectStore('files', { keyPath: 'name' });
                    fileStore.createIndex('lastModified', 'lastModified', { unique: false });
                }
                
                if (!db.objectStoreNames.contains('settings')) {
                    const settingsStore = db.createObjectStore('settings', { keyPath: 'key' });
                }
                
                console.log('IndexedDB è³‡æ–™è¡¨å‰µå»ºå®Œæˆ');
            };
        }
        
        function saveToIndexedDB() {
            if (!db) {
                alert('è³‡æ–™åº«æœªåˆå§‹åŒ–');
                return;
            }
            
            if (Object.keys(files).length === 0) {
                alert('æ²’æœ‰æª”æ¡ˆå¯ä»¥å„²å­˜');
                return;
            }
            
            const transaction = db.transaction(['files', 'settings'], 'readwrite');
            const fileStore = transaction.objectStore('files');
            const settingsStore = transaction.objectStore('settings');
            
            let savedCount = 0;
            let totalFiles = Object.keys(files).length;
            
            // å„²å­˜æ‰€æœ‰æª”æ¡ˆ
            for (const [fileName, fileData] of Object.entries(files)) {
                const fileRecord = {
                    name: fileName,
                    content: fileData.content,
                    lastModified: new Date(),
                    saved: true,
                    extension: getFileExtension(fileName)
                };
                
                const request = fileStore.put(fileRecord);
                
                request.onsuccess = function() {
                    savedCount++;
                    if (savedCount === totalFiles) {
                        // æ‰€æœ‰æª”æ¡ˆéƒ½å„²å­˜å®Œæˆï¼Œå„²å­˜è¨­å®š
                        const settings = {
                            key: 'editorSettings',
                            currentFile: currentFile,
                            fileCounter: fileCounter,
                            savedAt: new Date()
                        };
                        
                        settingsStore.put(settings);
                        showAutosaveIndicator(`å·²å„²å­˜ ${totalFiles} å€‹æª”æ¡ˆåˆ°è³‡æ–™åº«`);
                    }
                };
                
                request.onerror = function(event) {
                    console.error(`å„²å­˜æª”æ¡ˆ ${fileName} å¤±æ•—:`, event.target.error);
                };
            }
            
            transaction.oncomplete = function() {
                // æ¨™è¨˜æ‰€æœ‰æª”æ¡ˆç‚ºå·²å„²å­˜
                for (const fileName of Object.keys(files)) {
                    files[fileName].saved = true;
                }
                updateUI();
                updateFileSelect();
            };
            
            transaction.onerror = function(event) {
                console.error('å„²å­˜åˆ° IndexedDB å¤±æ•—:', event.target.error);
                alert('å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨è¨­å®š');
            };
        }
        
        function loadFromIndexedDB() {
            if (!db) {
                console.log('è³‡æ–™åº«æœªåˆå§‹åŒ–ï¼Œç„¡æ³•è¼‰å…¥');
                return;
            }
            
            const transaction = db.transaction(['files', 'settings'], 'readonly');
            const fileStore = transaction.objectStore('files');
            const settingsStore = transaction.objectStore('settings');
            
            // è¼‰å…¥è¨­å®š
            const settingsRequest = settingsStore.get('editorSettings');
            settingsRequest.onsuccess = function(event) {
                const settings = event.target.result;
                if (settings) {
                    fileCounter = settings.fileCounter || 1;
                    console.log('è¼‰å…¥ç·¨è¼¯å™¨è¨­å®š');
                }
            };
            
            // è¼‰å…¥æ‰€æœ‰æª”æ¡ˆ
            const filesRequest = fileStore.getAll();
            filesRequest.onsuccess = function(event) {
                const fileRecords = event.target.result;
                
                if (fileRecords.length === 0) {
                    console.log('è³‡æ–™åº«ä¸­æ²’æœ‰æª”æ¡ˆ');
                    return;
                }
                
                // æ¸…ç©ºç¾æœ‰æª”æ¡ˆï¼ˆå¦‚æœéœ€è¦ï¼‰
                const shouldMerge = Object.keys(files).length > 0 && 
                    confirm(`ç›®å‰å·²æœ‰ ${Object.keys(files).length} å€‹æª”æ¡ˆï¼Œè¦åˆä½µè³‡æ–™åº«ä¸­çš„æª”æ¡ˆå—ï¼Ÿ\n\nå–æ¶ˆå°‡è¦†è“‹ç¾æœ‰æª”æ¡ˆ`);
                
                if (!shouldMerge) {
                    files = {};
                }
                
                // è¼‰å…¥æª”æ¡ˆ
                let loadedCount = 0;
                let duplicateCount = 0;
                
                fileRecords.forEach(record => {
                    let fileName = record.name;
                    
                    // è™•ç†é‡è¤‡æª”å
                    if (files[fileName] && shouldMerge) {
                        let counter = 1;
                        const nameParts = record.name.split('.');
                        const ext = nameParts.pop();
                        const baseName = nameParts.join('.');
                        
                        do {
                            fileName = `${baseName}_db${counter}.${ext}`;
                            counter++;
                        } while (files[fileName]);
                        
                        duplicateCount++;
                    }
                    
                    files[fileName] = {
                        content: record.content || '',
                        lastModified: record.lastModified || new Date(),
                        saved: true
                    };
                    
                    loadedCount++;
                });
                
                // è¨­å®šç•¶å‰æª”æ¡ˆ
                if (!currentFile && Object.keys(files).length > 0) {
                    // å¾è¨­å®šä¸­æ¢å¾©ç•¶å‰æª”æ¡ˆï¼Œæˆ–é¸æ“‡ç¬¬ä¸€å€‹
                    const settingsRequest = settingsStore.get('editorSettings');
                    settingsRequest.onsuccess = function(event) {
                        const settings = event.target.result;
                        let targetFile = null;
                        
                        if (settings && settings.currentFile && files[settings.currentFile]) {
                            targetFile = settings.currentFile;
                        } else {
                            targetFile = Object.keys(files)[0];
                        }
                        
                        currentFile = targetFile;
                        switchToFile(currentFile);
                    };
                } else if (currentFile && files[currentFile]) {
                    switchToFile(currentFile);
                }
                
                updateFileSelect();
                updateUI();
                
                let message = `å·²è¼‰å…¥ ${loadedCount} å€‹æª”æ¡ˆ`;
                if (duplicateCount > 0) {
                    message += `ï¼ˆ${duplicateCount} å€‹é‡è¤‡æª”æ¡ˆå·²é‡æ–°å‘½åï¼‰`;
                }
                showAutosaveIndicator(message);
            };
            
            filesRequest.onerror = function(event) {
                console.error('å¾ IndexedDB è¼‰å…¥å¤±æ•—:', event.target.error);
            };
        }
        
        function exportAllFiles() {
            if (Object.keys(files).length === 0) {
                alert('æ²’æœ‰æª”æ¡ˆå¯ä»¥åŒ¯å‡º');
                return;
            }
            
            const exportData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                currentFile: currentFile,
                fileCounter: fileCounter,
                files: {}
            };
            
            // æº–å‚™æª”æ¡ˆè³‡æ–™
            for (const [fileName, fileData] of Object.entries(files)) {
                exportData.files[fileName] = {
                    content: fileData.content,
                    lastModified: fileData.lastModified,
                    extension: getFileExtension(fileName)
                };
            }
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `code-editor-backup-${new Date().getTime()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showAutosaveIndicator(`å·²åŒ¯å‡º ${Object.keys(files).length} å€‹æª”æ¡ˆ`);
        }
        
        function clearDatabase() {
            if (!db) {
                alert('è³‡æ–™åº«æœªåˆå§‹åŒ–');
                return;
            }
            
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤è³‡æ–™åº«ä¸­çš„æ‰€æœ‰è³‡æ–™å—ï¼Ÿ\n\né€™å€‹æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                return;
            }
            
            const transaction = db.transaction(['files', 'settings'], 'readwrite');
            const fileStore = transaction.objectStore('files');
            const settingsStore = transaction.objectStore('settings');
            
            const clearFiles = fileStore.clear();
            const clearSettings = settingsStore.clear();
            
            clearFiles.onsuccess = function() {
                console.log('æª”æ¡ˆè³‡æ–™å·²æ¸…é™¤');
            };
            
            clearSettings.onsuccess = function() {
                console.log('è¨­å®šè³‡æ–™å·²æ¸…é™¤');
            };
            
            transaction.oncomplete = function() {
                showAutosaveIndicator('è³‡æ–™åº«å·²æ¸…ç©º');
            };
            
            transaction.onerror = function(event) {
                console.error('æ¸…é™¤è³‡æ–™åº«å¤±æ•—:', event.target.error);
                alert('æ¸…é™¤å¤±æ•—');
            };
        }
        
        // åŒ¯å…¥æª”æ¡ˆåŠŸèƒ½ï¼ˆè™•ç† JSON å‚™ä»½æª”æ¡ˆï¼‰
        function handleImportFile(file) {
            if (file.type === 'application/json' && file.name.includes('code-editor-backup')) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importData = JSON.parse(e.target.result);
                        
                        if (!importData.files || typeof importData.files !== 'object') {
                            throw new Error('ç„¡æ•ˆçš„å‚™ä»½æª”æ¡ˆæ ¼å¼');
                        }
                        
                        const shouldMerge = Object.keys(files).length > 0 && 
                            confirm(`è¦åˆä½µå‚™ä»½æª”æ¡ˆä¸­çš„ ${Object.keys(importData.files).length} å€‹æª”æ¡ˆå—ï¼Ÿ\n\nå–æ¶ˆå°‡è¦†è“‹ç¾æœ‰æª”æ¡ˆ`);
                        
                        if (!shouldMerge) {
                            files = {};
                        }
                        
                        let importedCount = 0;
                        let duplicateCount = 0;
                        
                        for (const [fileName, fileData] of Object.entries(importData.files)) {
                            let targetFileName = fileName;
                            
                            // è™•ç†é‡è¤‡æª”å
                            if (files[targetFileName] && shouldMerge) {
                                let counter = 1;
                                const nameParts = fileName.split('.');
                                const ext = nameParts.pop();
                                const baseName = nameParts.join('.');
                                
                                do {
                                    targetFileName = `${baseName}_imported${counter}.${ext}`;
                                    counter++;
                                } while (files[targetFileName]);
                                
                                duplicateCount++;
                            }
                            
                            files[targetFileName] = {
                                content: fileData.content || '',
                                lastModified: new Date(fileData.lastModified) || new Date(),
                                saved: true
                            };
                            
                            importedCount++;
                        }
                        
                        // æ¢å¾©è¨­å®š
                        if (importData.fileCounter) {
                            fileCounter = Math.max(fileCounter, importData.fileCounter);
                        }
                        
                        // è¨­å®šç•¶å‰æª”æ¡ˆ
                        if (!currentFile && Object.keys(files).length > 0) {
                            if (importData.currentFile && files[importData.currentFile]) {
                                currentFile = importData.currentFile;
                            } else {
                                currentFile = Object.keys(files)[0];
                            }
                            switchToFile(currentFile);
                        }
                        
                        updateFileSelect();
                        updateUI();
                        
                        let message = `å·²åŒ¯å…¥ ${importedCount} å€‹æª”æ¡ˆ`;
                        if (duplicateCount > 0) {
                            message += `ï¼ˆ${duplicateCount} å€‹é‡è¤‡æª”æ¡ˆå·²é‡æ–°å‘½åï¼‰`;
                        }
                        showAutosaveIndicator(message);
                        
                    } catch (error) {
                        alert(`åŒ¯å…¥å¤±æ•—: ${error.message}`);
                        console.error('åŒ¯å…¥éŒ¯èª¤:', error);
                    }
                };
                reader.readAsText(file);
                return true;
            }
            return false;
        }
        
        // æœå°‹åŠŸèƒ½
        function toggleSearch() {
            isSearchVisible = !isSearchVisible;
            searchToolbar.style.display = isSearchVisible ? 'flex' : 'none';
            
            if (isSearchVisible) {
                searchInput.focus();
                if (searchInput.value) {
                    performSearch();
                }
            } else {
                clearSearchHighlights();
                searchResults = [];
                currentSearchIndex = -1;
                updateSearchResults();
            }
        }
        
        function performSearch() {
            const searchTerm = searchInput.value;
            if (!searchTerm || !currentFile) {
                clearSearchHighlights();
                searchResults = [];
                currentSearchIndex = -1;
                updateSearchResults();
                return;
            }
            
            const content = codeEditor.value;
            const caseSensitive = caseSensitiveToggle.checked;
            const wholeWord = wholeWordToggle.checked;
            
            searchResults = [];
            
            // å»ºæ§‹æœå°‹æ­£å‰‡è¡¨é”å¼
            let regex;
            try {
                let pattern = wholeWord ? `\\b${escapeRegExp(searchTerm)}\\b` : escapeRegExp(searchTerm);
                regex = new RegExp(pattern, caseSensitive ? 'g' : 'gi');
            } catch (e) {
                // å¦‚æœæ­£å‰‡è¡¨é”å¼æœ‰éŒ¯èª¤ï¼Œä½¿ç”¨ç°¡å–®å­—ä¸²æœå°‹
                searchResults = findSimpleMatches(content, searchTerm, caseSensitive, wholeWord);
                currentSearchIndex = searchResults.length > 0 ? 0 : -1;
                updateSearchResults();
                highlightSearchResults();
                return;
            }
            
            let match;
            const lines = content.split('\n');
            let totalLength = 0;
            
            // è¨ˆç®—æ¯è¡Œçš„èµ·å§‹ä½ç½®
            const lineStartPositions = [0];
            for (let i = 0; i < lines.length - 1; i++) {
                totalLength += lines[i].length + 1; // +1 for newline
                lineStartPositions.push(totalLength);
            }
            
            // æ‰¾åˆ°æ‰€æœ‰åŒ¹é…
            while ((match = regex.exec(content)) !== null) {
                const matchStart = match.index;
                const matchEnd = matchStart + match[0].length;
                
                // æ‰¾åˆ°åŒ¹é…æ‰€åœ¨çš„è¡Œè™Ÿ
                let lineNumber = 0;
                for (let i = 0; i < lineStartPositions.length; i++) {
                    if (matchStart < lineStartPositions[i]) {
                        lineNumber = i;
                        break;
                    }
                    if (i === lineStartPositions.length - 1) {
                        lineNumber = i + 1;
                        break;
                    }
                }
                
                // è¨ˆç®—åœ¨è©²è¡Œä¸­çš„ä½ç½®
                const lineStartPos = lineStartPositions[lineNumber - 1] || 0;
                const columnNumber = matchStart - lineStartPos + 1;
                
                searchResults.push({
                    start: matchStart,
                    end: matchEnd,
                    line: lineNumber,
                    column: columnNumber,
                    text: match[0]
                });
                
                // é˜²æ­¢ç„¡é™å¾ªç’°
                if (match[0].length === 0) {
                    regex.lastIndex++;
                }
            }
            
            currentSearchIndex = searchResults.length > 0 ? 0 : -1;
            updateSearchResults();
            highlightSearchResults();
            
            // è·³åˆ°ç¬¬ä¸€å€‹çµæœ
            if (currentSearchIndex >= 0) {
                scrollToSearchResult(currentSearchIndex);
            }
        }
        
        function findSimpleMatches(content, searchTerm, caseSensitive, wholeWord) {
            const results = [];
            const searchText = caseSensitive ? content : content.toLowerCase();
            const term = caseSensitive ? searchTerm : searchTerm.toLowerCase();
            
            let startIndex = 0;
            const lines = content.split('\n');
            let totalLength = 0;
            
            // è¨ˆç®—æ¯è¡Œçš„èµ·å§‹ä½ç½®
            const lineStartPositions = [0];
            for (let i = 0; i < lines.length - 1; i++) {
                totalLength += lines[i].length + 1;
                lineStartPositions.push(totalLength);
            }
            
            while (true) {
                const index = searchText.indexOf(term, startIndex);
                if (index === -1) break;
                
                // æª¢æŸ¥æ•´å­—åŒ¹é…
                if (wholeWord) {
                    const beforeChar = index > 0 ? content[index - 1] : '';
                    const afterChar = index + term.length < content.length ? content[index + term.length] : '';
                    
                    if (/\w/.test(beforeChar) || /\w/.test(afterChar)) {
                        startIndex = index + 1;
                        continue;
                    }
                }
                
                // æ‰¾åˆ°åŒ¹é…æ‰€åœ¨çš„è¡Œè™Ÿ
                let lineNumber = 0;
                for (let i = 0; i < lineStartPositions.length; i++) {
                    if (index < lineStartPositions[i]) {
                        lineNumber = i;
                        break;
                    }
                    if (i === lineStartPositions.length - 1) {
                        lineNumber = i + 1;
                        break;
                    }
                }
                
                // è¨ˆç®—åœ¨è©²è¡Œä¸­çš„ä½ç½®
                const lineStartPos = lineStartPositions[lineNumber - 1] || 0;
                const columnNumber = index - lineStartPos + 1;
                
                results.push({
                    start: index,
                    end: index + searchTerm.length,
                    line: lineNumber,
                    column: columnNumber,
                    text: content.substring(index, index + searchTerm.length)
                });
                
                startIndex = index + 1;
            }
            
            return results;
        }
        
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        function navigateSearch(direction) {
            if (searchResults.length === 0) return;
            
            currentSearchIndex += direction;
            
            if (currentSearchIndex >= searchResults.length) {
                currentSearchIndex = 0;
            } else if (currentSearchIndex < 0) {
                currentSearchIndex = searchResults.length - 1;
            }
            
            updateSearchResults();
            highlightSearchResults();
            scrollToSearchResult(currentSearchIndex);
        }
        
        function scrollToSearchResult(index) {
            if (index < 0 || index >= searchResults.length) return;
            
            const result = searchResults[index];
            const lines = codeEditor.value.substring(0, result.start).split('\n');
            const lineHeight = 21; // åŸºæ–¼ line-height: 1.5 å’Œ font-size: 14px
            const scrollTop = Math.max(0, (lines.length - 1) * lineHeight - codeEditor.clientHeight / 2);
            
            codeEditor.scrollTop = scrollTop;
            syntaxHighlight.scrollTop = scrollTop;
            lineNumbers.scrollTop = scrollTop;
            
            // è¨­ç½®å…‰æ¨™ä½ç½®
            codeEditor.focus();
            codeEditor.setSelectionRange(result.start, result.end);
        }
        
        function updateSearchResults() {
            if (searchResults.length === 0) {
                searchResultsDiv.textContent = searchInput.value ? 'ç„¡åŒ¹é…çµæœ' : '';
                prevBtn.disabled = true;
                nextBtn.disabled = true;
            } else {
                const current = currentSearchIndex + 1;
                const total = searchResults.length;
                const currentResult = searchResults[currentSearchIndex];
                searchResultsDiv.textContent = `${current}/${total} (è¡Œ ${currentResult.line})`;
                prevBtn.disabled = false;
                nextBtn.disabled = false;
            }
        }
        
        function highlightSearchResults() {
            if (!currentFile) return;
            
            // æ›´æ–°èªæ³•é«˜äº®ï¼ŒåŒ…æ‹¬æœå°‹é«˜äº®
            updateSyntaxHighlight();
        }
        
        function clearSearchHighlights() {
            updateSyntaxHighlight();
        }
        
        // èªæ³•é«˜äº®
        function highlightSyntax(code, fileExt) {
            let highlightedCode = code;
            
            // è½‰æ›HTMLç‰¹æ®Šå­—ç¬¦
            highlightedCode = highlightedCode.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            if (fileExt === 'html' || fileExt === 'htm') {
                // HTMLèªæ³•é«˜äº®
                highlightedCode = highlightedCode.replace(/(&lt;!DOCTYPE[^&]*&gt;)/g, '<span class="html-doctype">$1</span>');
                highlightedCode = highlightedCode.replace(/(&lt;!--[\s\S]*?--&gt;)/g, '<span class="html-comment">$1</span>');
                highlightedCode = highlightedCode.replace(/(&lt;\/?)([a-zA-Z][a-zA-Z0-9]*)(.*?)(&gt;)/g, function(match, open, tagName, attrs, close) {
                    let highlighted = '<span class="html-tag">' + open + tagName + '</span>';
                    attrs = attrs.replace(/([a-zA-Z-]+)(\s*=\s*)(["'])(.*?)\3/g, 
                        '<span class="html-attribute">$1</span>$2<span class="html-string">$3$4$3</span>');
                    return highlighted + attrs + '<span class="html-tag">' + close + '</span>';
                });
                
                // CSS in style tags
                highlightedCode = highlightedCode.replace(/(&lt;style[^&]*&gt;)([\s\S]*?)(&lt;\/style&gt;)/gi, function(match, openTag, cssContent, closeTag) {
                    cssContent = cssContent.replace(/(\/\*[\s\S]*?\*\/)/g, '<span class="js-comment">$1</span>');
                    cssContent = cssContent.replace(/([^{}]+)(\s*\{[^}]*\})/g, function(cssMatch, selector, block) {
                        selector = '<span class="css-selector">' + selector.trim() + '</span>';
                        block = block.replace(/([a-zA-Z-]+)(\s*:\s*)([^;]+)(;?)/g, 
                            '<span class="css-property">$1</span>$2<span class="css-value">$3</span>$4');
                        return selector + block;
                    });
                    return openTag + cssContent + closeTag;
                });
                
                // JS in script tags
                highlightedCode = highlightedCode.replace(/(&lt;script[^&]*&gt;)([\s\S]*?)(&lt;\/script&gt;)/gi, function(match, openTag, jsContent, closeTag) {
                    jsContent = highlightJS(jsContent);
                    return openTag + jsContent + closeTag;
                });
            } else if (fileExt === 'css') {
                // CSSèªæ³•é«˜äº®
                highlightedCode = highlightedCode.replace(/(\/\*[\s\S]*?\*\/)/g, '<span class="js-comment">$1</span>');
                highlightedCode = highlightedCode.replace(/([^{}]+)(\s*\{[^}]*\})/g, function(cssMatch, selector, block) {
                    selector = '<span class="css-selector">' + selector.trim() + '</span>';
                    block = block.replace(/([a-zA-Z-]+)(\s*:\s*)([^;]+)(;?)/g, 
                        '<span class="css-property">$1</span>$2<span class="css-value">$3</span>$4');
                    return selector + block;
                });
            } else if (fileExt === 'js' || fileExt === 'ts' || fileExt === 'jsx' || fileExt === 'tsx') {
                // JavaScriptèªæ³•é«˜äº®
                highlightedCode = highlightJS(highlightedCode);
            }
            
            // æ·»åŠ æœå°‹é«˜äº®
            if (searchResults.length > 0 && searchInput.value) {
                highlightedCode = addSearchHighlights(highlightedCode, code);
            }
            
            return highlightedCode;
        }
        
        function addSearchHighlights(highlightedCode, originalCode) {
            // å‰µå»ºä¸€å€‹æ˜ å°„ï¼Œå°‡åŸå§‹ä½ç½®å°æ‡‰åˆ°é«˜äº®å¾Œçš„ä½ç½®
            let offset = 0;
            let result = highlightedCode;
            
            // æŒ‰ä½ç½®å€’åºè™•ç†ï¼Œé¿å…ä½ç½®åç§»å•é¡Œ
            const sortedResults = [...searchResults].sort((a, b) => b.start - a.start);
            
            for (let i = 0; i < sortedResults.length; i++) {
                const searchResult = sortedResults[i];
                const originalIndex = sortedResults.findIndex(r => r === searchResult);
                
                // ç²å–è¦é«˜äº®çš„æ–‡å­—ï¼ˆéœ€è¦è½‰ç¾©HTMLï¼‰
                const searchText = originalCode.substring(searchResult.start, searchResult.end);
                const escapedText = searchText.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                
                // åœ¨é«˜äº®å¾Œçš„ä»£ç¢¼ä¸­æ‰¾åˆ°å°æ‡‰ä½ç½®ï¼ˆé€™æ˜¯ä¸€å€‹ç°¡åŒ–çš„æ–¹æ³•ï¼‰
                const regex = new RegExp(escapeRegExp(escapedText), 'g');
                let matches = 0;
                let targetMatch = searchResults.length - 1 - i;
                
                result = result.replace(regex, function(match, position) {
                    if (matches === targetMatch) {
                        const isCurrentResult = originalIndex === currentSearchIndex;
                        const className = isCurrentResult ? 'search-highlight current' : 'search-highlight';
                        matches++;
                        return `<span class="${className}">${match}</span>`;
                    }
                    matches++;
                    return match;
                });
            }
            
            return result;
        }
        
        function highlightJS(jsContent) {
            // JSè¨»é‡‹
            jsContent = jsContent.replace(/(\/\/.*$)/gm, '<span class="js-comment">$1</span>');
            jsContent = jsContent.replace(/(\/\*[\s\S]*?\*\/)/g, '<span class="js-comment">$1</span>');
            
            // å­—ç¬¦ä¸²
            jsContent = jsContent.replace(/(["'`])((?:\\.|(?!\1)[^\\])*)\1/g, '<span class="js-string">$1$2$1</span>');
            
            // æ•¸å­—
            jsContent = jsContent.replace(/\b(\d+\.?\d*)\b/g, '<span class="js-number">$1</span>');
            
            // é—œéµå­—
            jsContent = jsContent.replace(/\b(function|var|let|const|if|else|for|while|return|true|false|null|undefined|new|this|class|extends|import|export|from|async|await|try|catch|finally|throw|typeof|instanceof)\b/g, 
                '<span class="js-keyword">$1</span>');
            
            return jsContent;
        }
        
        function updateLineNumbers() {
            const content = codeEditor.value;
            const lines = content.split('\n').length;
            
            let lineNumbersContent = '';
            for (let i = 1; i <= lines; i++) {
                lineNumbersContent += i + '\n';
            }
            
            lineNumbers.textContent = lineNumbersContent.slice(0, -1); // ç§»é™¤æœ€å¾Œçš„æ›è¡Œ
        }
        
        function updateSyntaxHighlight() {
            if (!currentFile) {
                syntaxHighlight.innerHTML = '';
                lineNumbers.textContent = '1';
                return;
            }
            
            const code = codeEditor.value;
            const fileExt = getFileExtension(currentFile);
            syntaxHighlight.innerHTML = highlightSyntax(code, fileExt);
            updateLineNumbers();
        }
        
        function syncScroll() {
            syntaxHighlight.scrollTop = codeEditor.scrollTop;
            syntaxHighlight.scrollLeft = codeEditor.scrollLeft;
            lineNumbers.scrollTop = codeEditor.scrollTop;
        }
        
        // æª”æ¡ˆæ“ä½œ
        function newFile() {
            let fileName;
            do {
                fileName = `untitled${fileCounter}.html`;
                fileCounter++;
            } while (files[fileName]);
            
            files[fileName] = {
                content: '',
                lastModified: new Date(),
                saved: true
            };
            
            currentFile = fileName;
            updateFileSelect();
            switchToFile(fileName);
            saveToLocalStorage();
        }
        
        function openFiles() {
            document.getElementById('fileInput').click();
        }
        
        function handleFileLoad(event) {
            const fileList = event.target.files;
            
            for (let file of fileList) {
                // å…ˆæª¢æŸ¥æ˜¯å¦ç‚ºå‚™ä»½æª”æ¡ˆ
                if (handleImportFile(file)) {
                    continue;
                }
                
                // ä¸€èˆ¬æª”æ¡ˆè™•ç†
                if (isValidFileType(file.name)) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        let fileName = file.name;
                        let counter = 1;
                        
                        // è™•ç†é‡è¤‡æª”å
                        while (files[fileName]) {
                            const nameParts = file.name.split('.');
                            const ext = nameParts.pop();
                            const baseName = nameParts.join('.');
                            fileName = `${baseName}(${counter}).${ext}`;
                            counter++;
                        }
                        
                        files[fileName] = {
                            content: e.target.result,
                            lastModified: new Date(),
                            saved: true
                        };
                        
                        if (!currentFile) {
                            currentFile = fileName;
                            switchToFile(fileName);
                        }
                        
                        updateFileSelect();
                        saveToLocalStorage();
                    };
                    reader.readAsText(file);
                } else {
                    alert(`ä¸æ”¯æ´çš„æª”æ¡ˆé¡å‹: ${file.name}`);
                }
            }
            
            event.target.value = '';
        }
        
        function isValidFileType(fileName) {
            const validExtensions = [
                'html', 'htm', 'css', 'js', 'txt', 'json', 'xml', 'md',
                'py', 'java', 'cpp', 'c', 'php', 'rb', 'go', 'rs',
                'ts', 'jsx', 'tsx', 'vue', 'scss', 'sass', 'less',
                'sql', 'sh', 'bat', 'yaml', 'yml', 'ini', 'cfg', 'conf'
            ];
            const ext = getFileExtension(fileName);
            return validExtensions.includes(ext) || fileName.includes('code-editor-backup');
        }
        
        function getFileExtension(fileName) {
            return fileName.split('.').pop().toLowerCase();
        }
        
        function saveFile() {
            if (!currentFile) {
                alert('æ²’æœ‰æª”æ¡ˆå¯ä»¥å„²å­˜');
                return;
            }
            
            const content = codeEditor.value;
            const blob = new Blob([content], { type: getMimeType(currentFile) });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFile;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            // æ¨™è¨˜ç‚ºå·²å„²å­˜
            files[currentFile].saved = true;
            files[currentFile].lastModified = new Date();
            isModified = false;
            updateUI();
        }
        
        function getMimeType(fileName) {
            const ext = getFileExtension(fileName);
            const mimeTypes = {
                'html': 'text/html',
                'htm': 'text/html',
                'css': 'text/css',
                'js': 'application/javascript',
                'json': 'application/json',
                'xml': 'application/xml',
                'txt': 'text/plain',
                'md': 'text/markdown',
                'py': 'text/x-python',
                'java': 'text/x-java',
                'cpp': 'text/x-c++src',
                'c': 'text/x-csrc'
            };
            return mimeTypes[ext] || 'text/plain';
        }
        
        function closeFile() {
            if (!currentFile) return;
            
            // å…ˆå„²å­˜ç•¶å‰æª”æ¡ˆçš„å…§å®¹
            if (files[currentFile]) {
                files[currentFile].content = codeEditor.value;
            }
            
            if (!files[currentFile].saved) {
                if (!confirm(`æª”æ¡ˆ "${currentFile}" å°šæœªå„²å­˜ï¼Œç¢ºå®šè¦é—œé–‰å—ï¼Ÿ`)) {
                    return;
                }
            }
            
            const fileToClose = currentFile;
            delete files[fileToClose];
            
            // é¸æ“‡ä¸‹ä¸€å€‹æª”æ¡ˆ
            const fileNames = Object.keys(files);
            if (fileNames.length > 0) {
                // é¸æ“‡ç¬¬ä¸€å€‹å¯ç”¨çš„æª”æ¡ˆ
                currentFile = fileNames[0];
                switchToFile(currentFile);
            } else {
                // æ²’æœ‰å…¶ä»–æª”æ¡ˆäº†
                currentFile = null;
                codeEditor.value = '';
                codeEditor.placeholder = 'é¸æ“‡æˆ–å‰µå»ºä¸€å€‹æª”æ¡ˆé–‹å§‹ç·¨è¼¯...';
                syntaxHighlight.innerHTML = '';
                lineNumbers.textContent = '1';
            }
            
            updateFileSelect();
            updateUI();
            saveToLocalStorage();
            
            // æ¸…é™¤æœå°‹çµæœï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            if (isSearchVisible) {
                clearSearchHighlights();
                searchResults = [];
                currentSearchIndex = -1;
                updateSearchResults();
            }
        }
        
        function renameFile() {
            if (!currentFile) {
                alert('æ²’æœ‰é¸æ“‡æª”æ¡ˆ');
                return;
            }
            
            const newName = prompt('è¼¸å…¥æ–°çš„æª”æ¡ˆåç¨±:', currentFile);
            if (!newName || newName === currentFile) return;
            
            // æª¢æŸ¥éæ³•å­—å…ƒ
            if (/[<>:"/\\|?*]/.test(newName)) {
                alert('æª”æ¡ˆåç¨±åŒ…å«éæ³•å­—å…ƒ: < > : " / \\ | ? *');
                return;
            }
            
            // æª¢æŸ¥é‡è¤‡åç¨±
            if (files[newName]) {
                alert('æª”æ¡ˆåç¨±å·²å­˜åœ¨');
                return;
            }
            
            // é‡æ–°å‘½å
            files[newName] = files[currentFile];
            delete files[currentFile];
            currentFile = newName;
            
            updateFileSelect();
            updateUI();
            saveToLocalStorage();
        }
        
        function switchToFile(fileName) {
            if (!fileName || !files[fileName]) return;
            
            // å„²å­˜ç•¶å‰æª”æ¡ˆå…§å®¹ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
            if (currentFile && files[currentFile] && currentFile !== fileName) {
                files[currentFile].content = codeEditor.value;
                console.log(`å„²å­˜æª”æ¡ˆ ${currentFile} çš„å…§å®¹:`, files[currentFile].content.substring(0, 50) + '...');
            }
            
            // åˆ‡æ›åˆ°æ–°æª”æ¡ˆ
            currentFile = fileName;
            codeEditor.value = files[fileName].content || '';
            codeEditor.placeholder = '';
            isModified = false;
            
            console.log(`è¼‰å…¥æª”æ¡ˆ ${fileName} çš„å…§å®¹:`, files[fileName].content.substring(0, 50) + '...');
            
            updateUI();
            updateSyntaxHighlight();
            updateLineNumbers();
            
            // é¡¯ç¤º/éš±è—åŸ·è¡ŒæŒ‰éˆ•
            const ext = getFileExtension(fileName);
            runBtn.style.display = (ext === 'html' || ext === 'htm') ? 'inline-block' : 'none';
            
            // å¦‚æœæœå°‹åŠŸèƒ½é–‹å•Ÿï¼Œé‡æ–°åŸ·è¡Œæœå°‹
            if (isSearchVisible && searchInput.value) {
                performSearch();
            }
        }
        
        function updateFileSelect() {
            const fileNames = Object.keys(files);
            fileSelect.innerHTML = '<option value="">é¸æ“‡æª”æ¡ˆ...</option>';
            
            fileNames.forEach(fileName => {
                const option = document.createElement('option');
                option.value = fileName;
                option.textContent = fileName + (files[fileName].saved ? '' : ' *');
                if (fileName === currentFile) {
                    option.selected = true;
                }
                fileSelect.appendChild(option);
            });
        }
        
        function updateUI() {
            const fileNames = Object.keys(files);
            fileCount.textContent = `æª”æ¡ˆ: ${fileNames.length}`;
            
            if (currentFile) {
                fileStatus.textContent = `æª”æ¡ˆ: ${currentFile}`;
                saveStatus.textContent = files[currentFile].saved ? 'å·²å„²å­˜' : 'æœªå„²å­˜ *';
                saveStatus.style.color = files[currentFile].saved ? '#6a9955' : '#f14c4c';
            } else {
                fileStatus.textContent = 'æœªé¸æ“‡æª”æ¡ˆ';
                saveStatus.textContent = '';
            }
            
            const content = codeEditor.value;
            const lines = content ? content.split('\n').length : 0;
            lineCount.textContent = `è¡Œ: ${lines}`;
            charCount.textContent = `å­—å…ƒ: ${content.length}`;
        }
        
        // ç·¨è¼¯åŠŸèƒ½
        function copyAll() {
            if (!currentFile) {
                alert('æ²’æœ‰å…§å®¹å¯ä»¥è¤‡è£½');
                return;
            }
            
            navigator.clipboard.writeText(codeEditor.value).then(() => {
                showAutosaveIndicator('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
            }).catch(() => {
                // å‚™ç”¨æ–¹æ³•
                codeEditor.select();
                document.execCommand('copy');
                showAutosaveIndicator('å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
            });
        }
        
        function pasteContent() {
            if (!currentFile) {
                alert('è«‹å…ˆé¸æ“‡æˆ–å‰µå»ºä¸€å€‹æª”æ¡ˆ');
                return;
            }
            
            navigator.clipboard.readText().then(text => {
                const start = codeEditor.selectionStart;
                const end = codeEditor.selectionEnd;
                const currentValue = codeEditor.value;
                
                codeEditor.value = currentValue.substring(0, start) + text + currentValue.substring(end);
                codeEditor.selectionStart = codeEditor.selectionEnd = start + text.length;
                
                markAsModified();
                updateSyntaxHighlight();
                updateLineNumbers();
                scheduleAutosave();
            }).catch(() => {
                alert('ç„¡æ³•è®€å–å‰ªè²¼ç°¿å…§å®¹');
            });
        }
        
        function clearContent() {
            if (!currentFile) return;
            
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰å…§å®¹å—ï¼Ÿ')) {
                codeEditor.value = '';
                markAsModified();
                updateSyntaxHighlight();
                updateLineNumbers();
                scheduleAutosave();
            }
        }
        
        function runHTML() {
            if (!currentFile) return;
            
            const ext = getFileExtension(currentFile);
            if (ext !== 'html' && ext !== 'htm') return;
            
            const content = codeEditor.value;
            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            window.open(url, '_blank');
            
            // æ¸…ç†URL
            setTimeout(() => URL.revokeObjectURL(url), 1000);
        }
        
        function toggleWordWrap() {
            const wordWrap = document.getElementById('wordWrapToggle').checked;
            codeEditor.style.whiteSpace = wordWrap ? 'pre-wrap' : 'pre';
            syntaxHighlight.style.whiteSpace = wordWrap ? 'pre-wrap' : 'pre';
            updateLineNumbers(); // é‡æ–°è¨ˆç®—è¡Œè™Ÿ
        }
        
        function markAsModified() {
            if (currentFile && files[currentFile]) {
                files[currentFile].saved = false;
                isModified = true;
                updateUI();
                updateFileSelect();
            }
        }
        
        function scheduleAutosave() {
            clearTimeout(autosaveTimeout);
            autosaveTimeout = setTimeout(autosave, 1000);
        }
        
        function autosave() {
            if (currentFile && files[currentFile] && !files[currentFile].saved) {
                files[currentFile].content = codeEditor.value;
                files[currentFile].lastModified = new Date();
                saveToLocalStorage();
                
                // åŒæ™‚è‡ªå‹•å„²å­˜åˆ° IndexedDB
                if (db) {
                    const transaction = db.transaction(['files'], 'readwrite');
                    const fileStore = transaction.objectStore('files');
                    
                    const fileRecord = {
                        name: currentFile,
                        content: files[currentFile].content,
                        lastModified: files[currentFile].lastModified,
                        saved: true,
                        extension: getFileExtension(currentFile)
                    };
                    
                    fileStore.put(fileRecord);
                }
                
                showAutosaveIndicator('è‡ªå‹•å„²å­˜å®Œæˆ');
            }
        }
        
        function showAutosaveIndicator(message) {
            autosaveIndicator.textContent = message;
            autosaveIndicator.classList.add('show');
            setTimeout(() => {
                autosaveIndicator.classList.remove('show');
            }, 2000);
        }
        
        // æœ¬åœ°å­˜å„²
        function saveToLocalStorage() {
            try {
                localStorage.setItem('editorFiles', JSON.stringify(files));
                localStorage.setItem('editorCurrentFile', currentFile || '');
                localStorage.setItem('editorFileCounter', fileCounter.toString());
            } catch (e) {
                console.warn('ç„¡æ³•å„²å­˜åˆ°æœ¬åœ°å­˜å„²:', e);
            }
        }
        
        function loadFromLocalStorage() {
            try {
                const savedFiles = localStorage.getItem('editorFiles');
                const savedCurrentFile = localStorage.getItem('editorCurrentFile');
                const savedCounter = localStorage.getItem('editorFileCounter');
                
                if (savedFiles) {
                    files = JSON.parse(savedFiles);
                }
                
                if (savedCurrentFile && files[savedCurrentFile]) {
                    currentFile = savedCurrentFile;
                    switchToFile(currentFile);
                }
                
                if (savedCounter) {
                    fileCounter = parseInt(savedCounter);
                }
                
                updateFileSelect();
            } catch (e) {
                console.warn('ç„¡æ³•å¾æœ¬åœ°å­˜å„²è®€å–:', e);
            }
        }
        
        // äº‹ä»¶ç›£è½å™¨
        codeEditor.addEventListener('input', function() {
            // å³æ™‚æ›´æ–°ç•¶å‰æª”æ¡ˆçš„å…§å®¹
            if (currentFile && files[currentFile]) {
                files[currentFile].content = codeEditor.value;
            }
            
            markAsModified();
            updateUI();
            updateSyntaxHighlight();
            updateLineNumbers();
            scheduleAutosave();
            
            // å¦‚æœæœå°‹åŠŸèƒ½é–‹å•Ÿï¼Œé‡æ–°åŸ·è¡Œæœå°‹
            if (isSearchVisible && searchInput.value) {
                performSearch();
            }
        });
        
        codeEditor.addEventListener('scroll', syncScroll);
        
        codeEditor.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = this.selectionStart;
                const end = this.selectionEnd;
                this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
                this.selectionStart = this.selectionEnd = start + 4;
                markAsModified();
                updateSyntaxHighlight();
                updateLineNumbers();
                scheduleAutosave();
            }
        });
        
        fileSelect.addEventListener('change', function() {
            if (this.value) {
                switchToFile(this.value);
            }
        });
        
        document.getElementById('fileInput').addEventListener('change', handleFileLoad);
        
        // æœå°‹ç›¸é—œäº‹ä»¶ç›£è½å™¨
        searchInput.addEventListener('input', performSearch);
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if (e.shiftKey) {
                    navigateSearch(-1); // Shift+Enter: ä¸Šä¸€å€‹
                } else {
                    navigateSearch(1);  // Enter: ä¸‹ä¸€å€‹
                }
            } else if (e.key === 'Escape') {
                toggleSearch();
            }
        });
        
        // é˜²æ­¢æ„å¤–é›¢é–‹é é¢
        caseSensitiveToggle.addEventListener('change', performSearch);
        wholeWordToggle.addEventListener('change', performSearch);
        
        // éµç›¤å¿«æ·éµ
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 's':
                        e.preventDefault();
                        saveFile();
                        break;
                    case 'n':
                        e.preventDefault();
                        newFile();
                        break;
                    case 'o':
                        e.preventDefault();
                        openFiles();
                        break;
                    case 'w':
                        e.preventDefault();
                        closeFile();
                        break;
                    case 'f':
                        e.preventDefault();
                        if (!isSearchVisible) {
                            toggleSearch();
                        } else {
                            searchInput.focus();
                        }
                        break;
                    case 'h':
                        e.preventDefault();
                        // å¯ä»¥åœ¨é€™è£¡æ·»åŠ æ›¿æ›åŠŸèƒ½
                        break;
                }
            } else if (e.key === 'F3') {
                e.preventDefault();
                if (e.shiftKey) {
                    navigateSearch(-1);
                } else {
                    navigateSearch(1);
                }
            } else if (e.key === 'Escape') {
                if (isSearchVisible) {
                    toggleSearch();
                }
            }
        });
        
        // å®šæœŸè‡ªå‹•å„²å­˜åˆ°æœ¬åœ°å­˜å„²
        setInterval(() => {
            // å„²å­˜ç•¶å‰ç·¨è¼¯ä¸­çš„å…§å®¹
            if (currentFile && files[currentFile]) {
                files[currentFile].content = codeEditor.value;
            }
            saveToLocalStorage();
        }, 30000); // æ¯30ç§’è‡ªå‹•å„²å­˜ä¸€æ¬¡
        
        // é é¢é—œé–‰å‰ç¢ºä¿å„²å­˜
        window.addEventListener('beforeunload', function(e) {
            // å„²å­˜ç•¶å‰æª”æ¡ˆå…§å®¹
            if (currentFile && files[currentFile]) {
                files[currentFile].content = codeEditor.value;
                saveToLocalStorage();
            }
            
            const hasUnsavedFiles = Object.values(files).some(file => !file.saved);
            if (hasUnsavedFiles) {
                e.preventDefault();
                e.returnValue = 'æœ‰æœªå„²å­˜çš„æª”æ¡ˆï¼Œç¢ºå®šè¦é›¢é–‹å—ï¼Ÿ';
                return e.returnValue;
            }
        });
    </script>

  <script>
    const canvas = document.createElement('canvas');
    canvas.width = canvas.height = 64;
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, 64, 64); // å…¨é€æ˜
    document.getElementById('favicon').href = canvas.toDataURL();
  </script>
</body>
</html>