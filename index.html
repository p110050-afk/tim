<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>多檔編輯器（分頁版 CodeMirror）</title>

<!-- CodeMirror -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.15/lib/codemirror.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.15/theme/monokai.min.css">
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.15/lib/codemirror.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.15/mode/htmlmixed/htmlmixed.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.15/mode/javascript/javascript.js"></script>
<script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.15/mode/css/css.js"></script>

<style>
body {
  font-family: Consolas, monospace;
  margin: 0;
  padding: 0;
  background-color: #1e1e1e;
  color: #dcdcdc;
}
#toolbar {
  background-color: #333;
  padding: 5px 10px;
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 5px;
}
#toolbar button, #filename, #extension {
  background: #444;
  color: white;
  border: none;
  padding: 5px 10px;
  font-size: 14px;
  cursor: pointer;
}
#filename { width: 180px; }
#extension { width: 80px; }
#tabs {
  display: flex;
  gap: 5px;
  margin-left: 10px;
  flex-wrap: wrap;
}
.tab {
  padding: 5px 10px;
  background: #333;
  cursor: pointer;
  position: relative;
  border-radius: 4px 4px 0 0;
}
.tab.active { background: #555; }
.tab span.close {
  position: absolute;
  right: 3px;
  top: 0px;
  cursor: pointer;
  color: #f88;
}
.CodeMirror {
  height: calc(100vh - 100px);
  font-size: 14px;
  line-height: 1.5;
}
#autosaveTip {
  position: fixed;
  top: 10px;
  right: 10px;
  background-color: #2a2;
  color: white;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 14px;
  opacity: 0;
  transition: opacity 0.3s ease;
  z-index: 9999;
}
#autosaveTip.show { opacity: 1; }
input[type="file"] { display: none; }
</style>
</head>
<body>

<div id="toolbar">
  <button onclick="openFile()">開啟檔案</button>
  <button onclick="saveFile()">儲存檔案</button>
  <button onclick="newFile()">新增檔案</button>
  <button onclick="clearEditor()">清除程式碼</button>
  <button onclick="clearAll()">清除全部</button>
  <button onclick="runCode()">執行程式</button>
  <input type="text" id="filename" placeholder="檔名" />
  <input type="text" id="extension" placeholder="副檔名" />
  <div id="tabs"></div>
  <input type="file" id="fileInput" multiple />
</div>

<textarea id="editor">// 多檔編輯器</textarea>
<div id="autosaveTip">已自動儲存</div>

<script>
const fileInput = document.getElementById('fileInput');
const filenameInput = document.getElementById('filename');
const extensionInput = document.getElementById('extension');
const tabsContainer = document.getElementById('tabs');

let filesData = JSON.parse(localStorage.getItem('filesData')) || {};
let currentFile = localStorage.getItem('currentFile') || '';
let isDirty = false;
let autosaveTimer = null;

const cm = CodeMirror.fromTextArea(document.getElementById('editor'), {
  lineNumbers: true, mode: 'htmlmixed', theme: 'monokai', indentUnit: 2, tabSize: 2, lineWrapping: true
});

// Helper
function getModeByExtension(ext) {
  switch (ext.toLowerCase()) {
    case 'html': return 'htmlmixed';
    case 'js': return 'javascript';
    case 'css': return 'css';
    case 'json': return 'application/json';
    case 'txt': return 'text/plain';
    default: return 'text/plain';
  }
}
function getMimeByExtension(ext) {
  switch (ext.toLowerCase()) {
    case '.html': return 'text/html';
    case '.js': return 'application/javascript';
    case '.css': return 'text/css';
    case '.json': return 'application/json';
    default: return 'text/plain';
  }
}

// Editor change
cm.on('change', () => {
  isDirty = true;
  if (autosaveTimer) clearTimeout(autosaveTimer);
  autosaveTimer = setTimeout(() => {
    saveCurrentContent();
    showAutosaveTip();
  }, 2000);
});

// Tabs
function updateTabs() {
  tabsContainer.innerHTML = '';
  for (let name in filesData) {
    const tab = document.createElement('div');
    tab.className = 'tab' + (name===currentFile?' active':'');
    tab.textContent = name;
    const closeBtn = document.createElement('span');
    closeBtn.textContent = '×';
    closeBtn.className = 'close';
    closeBtn.onclick = (e) => { e.stopPropagation(); closeFile(name); };
    tab.appendChild(closeBtn);
    tab.onclick = () => switchFile(name);
    tabsContainer.appendChild(tab);
  }
}

function updateEditor() {
  if (!currentFile || !filesData[currentFile]) return;
  const file = filesData[currentFile];
  cm.setOption('mode', getModeByExtension(file.extension));
  cm.setValue(file.content);
  filenameInput.value = currentFile;
  extensionInput.value = file.extension;
  isDirty = false;
}

function saveCurrentContent() {
  if(currentFile && filesData[currentFile]){
    filesData[currentFile].content = cm.getValue();
    isDirty=false;
    localStorage.setItem('filesData', JSON.stringify(filesData));
    localStorage.setItem('currentFile', currentFile);
  }
}

function confirmSaveIfDirty() {
  if(isDirty) return confirm("目前檔案尚未儲存，是否儲存？未儲存的變更將會遺失。");
  return true;
}

// File operations
function openFile() { fileInput.click(); }
fileInput.addEventListener('change', e => {
  const files = Array.from(e.target.files);
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = ev => {
      const parts = file.name.split('.');
      const name = parts.slice(0,-1).join('.')||file.name;
      const ext = parts.length>1?parts.pop():'';
      filesData[name]={content: ev.target.result, extension: ext};
      currentFile=name;
      updateEditor();
      updateTabs();
      saveCurrentContent();
    };
    reader.readAsText(file);
  });
});

function newFile() {
  if(!confirmSaveIfDirty()) return;
  let counter=1, name;
  do { name=`untitled${counter}`; counter++; } while(filesData[name]);
  filesData[name]={content:'', extension:'txt'};
  currentFile=name;
  updateEditor();
  updateTabs();
  saveCurrentContent();
}

function switchFile(name){
  if(!confirmSaveIfDirty()) return;
  saveCurrentContent();
  currentFile=name;
  updateEditor();
  updateTabs();
}

function closeFile(name){
  if(name===currentFile && !confirmSaveIfDirty()) return;
  delete filesData[name];
  const keys=Object.keys(filesData);
  currentFile = keys.length>0?keys[0]:'';
  updateEditor();
  updateTabs();
  saveCurrentContent();
}

// Clear
function clearEditor(){ cm.setValue(''); isDirty=true; }
function clearAll(){ if(confirm("確定要清除全部內容嗎？")){ filesData={}; currentFile=''; updateEditor(); updateTabs(); localStorage.removeItem('filesData'); localStorage.removeItem('currentFile'); } }

// Save & Run
function saveFile(){
  saveCurrentContent();
  const name=filenameInput.value.trim()||'document';
  let ext=extensionInput.value.trim()||'txt';
  if(!ext.startsWith('.')) ext='.'+ext;
  const blob=new Blob([filesData[currentFile].content], {type:getMimeByExtension(ext)});
  const link=document.createElement('a');
  link.download=name+ext;
  link.href=URL.createObjectURL(blob);
  link.click();
}
function runCode(){
  const blob=new Blob([cm.getValue()], {type:'text/html'});
  const url=URL.createObjectURL(blob);
  window.open(url,'_blank');
}

// Autosave tip
function showAutosaveTip(){
  const tip=document.getElementById('autosaveTip');
  tip.classList.add('show');
  setTimeout(()=>tip.classList.remove('show'),2000);
}

// Filename change
filenameInput.addEventListener('change', ()=>{
  const newName=filenameInput.value.trim();
  if(newName && newName!==currentFile){
    if(filesData[newName]) alert('檔名已存在，請使用其他名稱');
    else{
      filesData[newName]=filesData[currentFile];
      delete filesData[currentFile];
      currentFile=newName;
      updateTabs();
      saveCurrentContent();
    }
  }
});

// Ctrl+S
document.addEventListener('keydown', (e)=>{
  if((e.ctrlKey||e.metaKey)&&e.key==='s'){ e.preventDefault(); saveFile(); }
});

// 初始化
if(Object.keys(filesData).length===0) newFile();
else updateTabs();
updateEditor();
</script>

</body>
</html>
